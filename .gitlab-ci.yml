stages:
  - images
  - current
  - compat

# First, test with the latest and greatest Mercurial, across the
# versions Python supported. We generally assume that if e.g. CPython
# 3.5 and 3.8 work, anything in between will work as well.
Latest:
  stage: current
  image: registry.heptapod.net:443/mercurial/hg-git/ci:py$PYTHON-hg-$HG
  script:
    - python$PYTHON tests/run-tests.py -v --xunit $PWD/tests-$PYTHON-$HG.xml --color=always
  parallel:
    matrix:
      - PYTHON:
          - "2.7"
          - "3.5"
          - "3.9"
        HG:
          - "5.6"
  artifacts:
    reports:
      junit: tests.xml

# This is the authoritative list of versions of Mercurial that this
# extension is supported and tested with; it should be kept in sync
# with __init__.py.
#
# Versions prior to the version that ships in the latest Ubuntu LTS
# release (4.5.3 for 18.04; 5.3.1 for 20.04) may be dropped if they
# interfere with new development. The latest released minor version
# should be listed for each major version; earlier minor versions are
# not needed.
Supported:
  stage: compat
  image: registry.heptapod.net:443/mercurial/hg-git/ci:py$PYTHON-hg-$HG
  retry: 1
  timeout: 5m
  script:
    - python$PYTHON tests/run-tests.py -v --color=always
  parallel:
    matrix:
      - PYTHON: "2.7"
        HG:
          - "4.4"
          - "4.5"
          - "4.6"
          - "4.7"
          - "4.8"
          - "4.9"
          - "5.0"
          - "5.1"
          - "5.2"
          - "5.3"
          - "5.4"
          - "5.5"
      - PYTHON: "3.9"
        HG:
          - "5.2"
          - "5.3"
          - "5.4"
          - "5.5"

# Test that it is possible to use and run hg-git on Ubuntu without
# compiling any C code, i.e. with stock Dulwich, Mercurial and
# CPython. This should most definitely be the case on the latest
# rolling release without a PPA. We can live with PPAs on older
# systems.
Ubuntu:
    stage: compat
    image: ubuntu:20.10
    script:
      - apt-get -qq update
      - >
        DEBIAN_FRONTEND=noninteractive
        apt-get -qq install --no-install-recommends
        gnupg gnupg-agent git unzip ssh
        mercurial python3-dulwich python3-setuptools pyflakes3
      - python3 tests/run-tests.py -v --color=always

# Test that the tests pass against the current branches
Development:
  stage: compat
  allow_failure: true
  image: registry.heptapod.net:443/mercurial/hg-git/ci:py$PYTHON-hg-$HG
  script:
    - python$PYTHON tests/run-tests.py -v --color=always
  parallel:
    matrix:
      - PYTHON:
          - "2.7"
          - "3.9"
        HG:
          - "stable"
          - "default"

# Build images for the above tasks; this should be a scheduled job, as
# it is quite unnecessary to run on every invocation.
Release images:
  stage: images
  only:
    - schedules
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - >
      /kaniko/executor --context $CI_PROJECT_DIR
      --dockerfile $CI_PROJECT_DIR/contrib/docker/Dockerfile.alpine
      --build-arg PYTHON=$PYTHON
      --build-arg HG=$HG
      --reproducible
      --single-snapshot
      --cleanup
      --destination registry.heptapod.net:443/mercurial/hg-git/ci:py$PYTHON-hg-$HG
  parallel:
    matrix:
      - PYTHON:
          - "2.7"
        HG:
          - "4.4"
          - "4.5"
          - "4.6"
          - "4.7"
          - "4.8"
          - "4.9"
          - "5.0"
          - "5.1"
      - PYTHON:
          - "2.7"
          - "3.9"
        HG:
          - "5.2"
          - "5.3"
          - "5.4"
          - "5.5"
      - PYTHON:
          - "2.7"
          - "3.5"
          - "3.9"
        HG:
          - "5.6"

# Build branch images; factored out so it may be invoked separately
Current images:
  extends: Release images
  only:
    - schedules
  parallel:
    matrix:
      - PYTHON:
          - "2.7"
          - "3.9"
        HG:
          - "default"
          - "stable"
